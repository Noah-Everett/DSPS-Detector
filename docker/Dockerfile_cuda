#############################################################################
####                    G4-DSPS-Detector-Simulation                      ####
#############################################################################
####                                                                     ####
#### Author:                                                             ####
####   Noah Everett (noah.everett@mines.sdsmt.edu)                       ####
####                                                                     ####
#### This file is based on the anniedirt Dockerfile created by me.       ####
#### https://github.com/ANNIEsoft/anniedirt/blob/genie_3_0_6/Dockerfile  ####
####                                                                     ####
#############################################################################
####                                                                     ####
#############################################################################



##############################
########## Set FROM ##########
##############################
FROM noaheverett/physicsbase:1.0.1-x86-Cuda



##############################
########## Set User ##########
##############################
USER root



#######################################
########## Miniconda & Mamba ##########
#######################################
RUN yum install -y wget bzip2 \
 && wget -qO /tmp/miniconda.sh https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh \
 && bash /tmp/miniconda.sh -b -p /opt/conda \
 && rm /tmp/miniconda.sh \
 && /opt/conda/bin/conda clean -afy

ENV PATH="/opt/conda/bin:$PATH"
ENV CONDA_PLUGINS_AUTO_ACCEPT_TOS=true

RUN conda create -y -n dsps python=3.11 pip \
 && conda clean -afy

# Use dsps env for all subsequent RUN steps
SHELL ["conda", "run", "-n", "dsps", "/bin/bash", "-lc"]

RUN conda install -y -n dsps -c conda-forge mamba \
 && conda clean -afy



####################################
########## pytorch-3dunet ##########
####################################
RUN mamba install -y -n dsps \
      -c pytorch -c nvidia -c conda-forge \
      pytorch \
      pytorch-cuda=12.1 \
      pytorch-3dunet \
 && mamba clean -afy



##########################
########## DSPS ##########
##########################
RUN source /setup_Dockerfile.sh \
 && git clone --recurse-submodules --depth 1 https://github.com/Noah-Everett/DSPS-Detector /DSPS \
 && cp /DSPS/docker/setup_Dockerfile.sh /setup_Dockerfile.sh \
 && cd /DSPS \
 && mkdir build && cd build \
 && cmake .. \
 && make -j${NCPU} \
 && cd /DSPS



#####################################
########## Python Packages ##########
#####################################
RUN pip install --no-cache-dir -r /DSPS/requirements.txt



##########################################
########## Fast-Voxel-Traversal ##########
##########################################
RUN source /setup_Dockerfile.sh \
 && git clone --depth 1 https://github.com/Noah-Everett/Fast-Voxel-Traversal-Python /Fast_Voxel_Traversal_Python \
 && cd /Fast_Voxel_Traversal_Python \
 && pip install . \
 && cd /
